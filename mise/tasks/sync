#!/bin/bash
#MISE description="Extract config from HA server"
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
CONFIG_DIR="$REPO_ROOT/config"

# Load secrets via Doppler if not already loaded
if [[ -z "${HA_SERVER:-}" ]]; then
    exec doppler run -- "$0" "$@"
fi

echo "üì• Extracting Home Assistant configuration files..."

cd "$CONFIG_DIR"

YAML_FILES=("automations.yaml" "scenes.yaml" "configuration.yaml")
SPLIT_FILES=("automations.yaml" "scenes.yaml")

download_if_has_content() {
    local file=$1
    local remote_path="/config/$file"
    local local_path="$CONFIG_DIR/$file"

    echo "üîç Checking $file..."
    file_size=$(ssh "$HA_SERVER" "[ -f '$remote_path' ] && wc -c < '$remote_path' 2>/dev/null || echo 0")

    if [ "$file_size" -gt 0 ]; then
        echo "  ‚úÖ Downloading $file ($file_size bytes)"
        scp -q "$HA_SERVER:$remote_path" "$local_path"
    else
        echo "  ‚è≠Ô∏è  Skipping $file (empty or missing)"
        [ -f "$local_path" ] && rm "$local_path"
    fi
}

split_yaml_file() {
    local file=$1
    local source_file="$CONFIG_DIR/$file"
    local base_name="${file%.yaml}"
    local output_dir="$CONFIG_DIR/$base_name"

    if [ ! -f "$source_file" ]; then
        echo "  ‚è≠Ô∏è  Skipping split of $file (not downloaded)"
        return
    fi

    echo "  üìÇ Splitting $file into individual files..."

    rm -rf "$output_dir"
    mkdir -p "$output_dir"

    entry_count=$(yq eval 'length' "$source_file")

    if [ "$entry_count" -gt 0 ]; then
        for i in $(seq 0 $((entry_count - 1))); do
            if [ "$base_name" = "automations" ]; then
                name=$(yq eval ".[$i].alias" "$source_file")
            else
                name=$(yq eval ".[$i].name" "$source_file")
            fi

            filename=$(echo "$name" | iconv -c -t ASCII//TRANSLIT 2>/dev/null | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_-')
            output_file="$output_dir/${filename}.yaml"

            counter=1
            while [ -f "$output_file" ]; do
                output_file="$output_dir/${filename}_${counter}.yaml"
                counter=$((counter + 1))
            done

            yq eval ".[$i]" "$source_file" > "$output_file"
        done

        echo "  ‚úÖ Split into $entry_count files in $base_name/"
    else
        echo "  ‚ö†Ô∏è  No entries found in $file"
    fi
}

for file in "${YAML_FILES[@]}"; do
    download_if_has_content "$file"
done

echo ""
echo "üìÇ Splitting automations and scenes into individual files..."

for file in "${SPLIT_FILES[@]}"; do
    split_yaml_file "$file"
done

echo ""
echo "üóëÔ∏è  Removing source files that were split..."
for file in "${SPLIT_FILES[@]}"; do
    source_file="$CONFIG_DIR/$file"
    if [ -f "$source_file" ]; then
        rm "$source_file"
        echo "  ‚úÖ Removed $file"
    fi
done

echo ""
echo "‚úÖ Configuration extraction complete!"
