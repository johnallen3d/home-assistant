#!/usr/bin/env -S uv run --script
#MISE description="Update scenes on HA server from local files"
# /// script
# requires-python = ">=3.12"
# dependencies = ["pyyaml"]
# ///
"""
Update Home Assistant scenes.yaml
Workflow: Pull from server ‚Üí Update from local file ‚Üí Push back

Usage:
  mise run scene-update config/scenes/alarm.yaml
  mise run scene-update config/scenes/*.yaml
"""

import os
import subprocess
import sys
from pathlib import Path

import yaml

# Load secrets via Doppler if not already loaded
if not os.environ.get("HA_SERVER"):
    os.execvp("doppler", ["doppler", "run", "--", sys.executable, *sys.argv])

SERVER = os.environ["HA_SERVER"]
CONFIG_PATH = os.environ["HA_CONFIG_PATH"]
SERVER_PATH = f"{CONFIG_PATH}/scenes.yaml"
LOCAL_TEMP = "/tmp/scenes.yaml"


def download_scenes():
    """Download current scenes.yaml from server"""
    print("üì• Downloading current scenes from server...")
    result = subprocess.run(
        ["scp", f"{SERVER}:{SERVER_PATH}", LOCAL_TEMP], capture_output=True, text=True
    )
    if result.returncode != 0:
        print(f"‚ùå Failed to download: {result.stderr}")
        sys.exit(1)
    print("‚úÖ Downloaded")


def upload_scenes():
    """Upload modified scenes.yaml back to server"""
    print("üì§ Uploading updated scenes to server...")
    result = subprocess.run(
        ["scp", LOCAL_TEMP, f"{SERVER}:{SERVER_PATH}"], capture_output=True, text=True
    )
    if result.returncode != 0:
        print(f"‚ùå Failed to upload: {result.stderr}")
        sys.exit(1)
    print("‚úÖ Uploaded")


def update_scene_from_file(local_file):
    """Update a scene in the server file using a local split file as source"""
    local_path = Path(local_file)
    if not local_path.exists():
        print(f"‚ùå Local file not found: {local_file}")
        return False

    with open(local_path) as f:
        local_scene = yaml.safe_load(f)

    if not local_scene or "id" not in local_scene:
        print(f"‚ùå Invalid scene file (missing id): {local_file}")
        return False

    scene_id = local_scene["id"]
    scene_name = local_scene.get("name", "Unknown")

    with open(LOCAL_TEMP) as f:
        server_scenes = yaml.safe_load(f)

    if not isinstance(server_scenes, list):
        print("‚ùå Server scenes.yaml is not a list")
        return False

    found = False
    for i, scene in enumerate(server_scenes):
        if scene.get("id") == scene_id:
            print(f"‚úèÔ∏è  Updating: {scene_name} (id: {scene_id})")
            server_scenes[i] = local_scene
            found = True
            break

    if not found:
        print(f"‚ùå Scene not found on server: {scene_name} (id: {scene_id})")
        return False

    with open(LOCAL_TEMP, "w") as f:
        yaml.dump(server_scenes, f, default_flow_style=False, allow_unicode=True, sort_keys=False)

    print(f"‚úÖ Updated: {scene_name}")
    return True


def main():
    if len(sys.argv) < 2:
        print("Usage: mise run scene-update <file> [<file2> ...]")
        print("Example: mise run scene-update config/scenes/alarm.yaml")
        sys.exit(1)

    download_scenes()

    updated_count = 0
    for file_path in sys.argv[1:]:
        if update_scene_from_file(file_path):
            updated_count += 1

    if updated_count > 0:
        upload_scenes()
        print(f"‚úÖ Successfully updated {updated_count} scene(s)")
    else:
        print("‚ùå No scenes were updated")
        sys.exit(1)


if __name__ == "__main__":
    main()
