# Scripts for Home Assistant

# =============================================================================
# Cooking Mode Toggle
# =============================================================================
# Simple toggle for cooking mode. The actual lighting logic is handled by
# automation.cooking_mode_changed which reacts to the boolean state.
#
# This script exists for:
#   - Kitchen button single press
#   - Voice command backup: "toggle cooking"
#
# Preferred interaction: Use input_boolean.cooking_mode directly (shows state)

toggle_cooking:
  alias: "Toggle Cooking"
  description: "Toggle cooking mode boolean"
  icon: mdi:chef-hat
  mode: single
  sequence:
    - action: input_boolean.toggle
      target:
        entity_id: input_boolean.cooking_mode


# =============================================================================
# Meditation Mode Toggle
# =============================================================================
# Toggles meditation mode. When active, creates a calm environment for meditation
# by turning off lights and disabling presence automation.
#
# Behavior:
#   - If meditation_mode OFF: Turn off bedroom, bathroom, living room, kitchen
#     lights (except island if someone is in meal zone), disable living room
#     presence automation
#   - If meditation_mode ON: Turn off meditation_mode, re-enable living room
#     presence automation
#
# Use Cases:
#   - Voice command: "meditation" or "meditation mode"

toggle_meditation:
  alias: "Toggle Meditation"
  description: "Toggle meditation mode - dims environment for meditation"
  icon: mdi:meditation
  mode: single
  sequence:
    - choose:
        # Meditation mode is currently OFF -> turn it ON
        - conditions:
            - condition: state
              entity_id: input_boolean.meditation_mode
              state: "off"
          sequence:
            - action: input_boolean.turn_on
              target:
                entity_id: input_boolean.meditation_mode
            # Turn off lights in dad's bedroom
            - action: light.turn_off
              target:
                entity_id: light.bedroom_lights
            # Turn off lights in dad's bathroom
            - action: light.turn_off
              target:
                entity_id: light.bathroom_lights
            # Turn off lights in living room
            - action: light.turn_off
              target:
                entity_id: light.living_room_lights
            # Turn off kitchen lights, but keep island if presence in meal zone
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.charlie_meal
                      state: "on"
                  sequence:
                    # Meal zone active - turn off everything except island bulb
                    - action: light.turn_off
                      target:
                        entity_id:
                          - light.sink_bulb
                          - light.hue_lightstrip_plus_1
                    - action: switch.turn_off
                      target:
                        entity_id: switch.kitchen_counter_switch
              default:
                # No meal zone presence - turn off all kitchen lights
                - action: homeassistant.turn_off
                  target:
                    entity_id: group.kitchen_all
            # Disable living room presence automation
            - action: automation.turn_off
              target:
                entity_id: automation.living_room_presence_lighting

        # Meditation mode is currently ON -> turn it OFF
        - conditions:
            - condition: state
              entity_id: input_boolean.meditation_mode
              state: "on"
          sequence:
            - action: input_boolean.turn_off
              target:
                entity_id: input_boolean.meditation_mode
            # Re-enable living room presence automation
            - action: automation.turn_on
              target:
                entity_id: automation.living_room_presence_lighting


# =============================================================================
# Adaptive Lighting - General Purpose
# =============================================================================
# Uses template sensors for brightness/color temp based on sun position,
# time of day, and weather conditions.
#
# Usage examples:
#   # Simple - all lights adaptive
#   - action: script.adaptive_lights
#     data:
#       lights:
#         - light.kitchen_lights
#         - light.living_room_light
#
#   # Night mode - turn off at night
#   - action: script.adaptive_lights
#     data:
#       lights: [light.bedroom_lamp, light.bedroom_overhead_left]
#       night_mode: "off"
#
#   # Night mode - dim RGB (bathroom style)
#   - action: script.adaptive_lights
#     data:
#       lights: [light.bathroom_lamp, light.bathroom_strip]
#       night_mode: dim_rgb
#       night_lights: [light.bathroom_strip]
#       night_rgb: [255, 159, 242]
#
#   # Night mode - dim warm white
#   - action: script.adaptive_lights
#     data:
#       lights: [light.kitchen_lights]
#       night_mode: dim_warm

lights:
  alias: "Lights"
  description: "Apply adaptive brightness and color temperature based on time/weather"
  icon: mdi:lightbulb-auto
  mode: parallel
  max: 10
  fields:
    lights:
      name: Lights
      description: "Light entities to control"
      required: true
      example: "[light.kitchen, light.island_bulb]"
      selector:
        entity:
          domain: light
          multiple: true
    night_mode:
      name: Night Mode
      description: "Behavior during night hours (11pm-6am)"
      default: "adaptive"
      example: "dim_rgb"
      selector:
        select:
          options:
            - label: "Adaptive (same as day)"
              value: "adaptive"
            - label: "Turn off"
              value: "off"
            - label: "Dim warm white"
              value: "dim_warm"
            - label: "Dim RGB color"
              value: "dim_rgb"
            - label: "Skip (don't change)"
              value: "skip"
    night_lights:
      name: Night Lights
      description: "Subset of lights to use at night (optional, defaults to all)"
      example: "[light.bathroom_strip]"
      selector:
        entity:
          domain: light
          multiple: true
    night_rgb:
      name: Night RGB Color
      description: "RGB color for dim_rgb mode"
      default: [255, 159, 242]
      example: "[255, 159, 242]"
      selector:
        color_rgb:
    night_brightness:
      name: Night Brightness
      description: "Brightness percent for night modes"
      default: 10
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
  sequence:
    - variables:
        brightness: "{{ states('sensor.adaptive_brightness') | int(50) }}"
        color_temp: "{{ states('sensor.adaptive_color_temp') | int(3000) }}"
        hour: "{{ now().hour }}"
        is_night: "{{ hour >= 23 or hour < 6 }}"
        mode: "{{ night_mode | default('adaptive') }}"
        rgb: "{{ night_rgb | default([255, 159, 242]) }}"
        night_pct: "{{ night_brightness | default(10) }}"
        # Use night_lights if provided, otherwise use all lights
        night_targets: "{{ night_lights | default(lights) }}"
    - choose:
        # Night + off mode: turn off all lights
        - conditions: "{{ is_night and mode == 'off' }}"
          sequence:
            - action: light.turn_off
              target:
                entity_id: "{{ lights }}"

        # Night + skip mode: do nothing
        - conditions: "{{ is_night and mode == 'skip' }}"
          sequence: []

        # Night + dim_warm mode: warm white at low brightness
        - conditions: "{{ is_night and mode == 'dim_warm' }}"
          sequence:
            - action: light.turn_on
              target:
                entity_id: "{{ night_targets }}"
              data:
                brightness_pct: "{{ night_pct }}"
                color_temp_kelvin: 2200

        # Night + dim_rgb mode: RGB color at low brightness
        - conditions: "{{ is_night and mode == 'dim_rgb' }}"
          sequence:
            - action: light.turn_on
              target:
                entity_id: "{{ night_targets }}"
              data:
                brightness_pct: "{{ night_pct }}"
                rgb_color: "{{ rgb }}"

      # Default: adaptive mode (day or night with adaptive)
      default:
        - action: light.turn_on
          target:
            entity_id: "{{ lights }}"
          data:
            brightness_pct: "{{ brightness }}"
            color_temp_kelvin: "{{ color_temp }}"


# =============================================================================
# Room-Specific Shortcuts (optional convenience wrappers)
# =============================================================================

# Bedroom Sunrise - Hue sunrise effect on all bedroom lights
bedroom_sunrise:
  alias: "Bedroom Sunrise"
  description: "Activate sunrise effect on bedroom lights"
  icon: mdi:weather-sunset-up
  mode: single
  sequence:
    - action: light.turn_on
      target:
        entity_id: light.bedroom_lamp
      data:
        effect: sunrise
    - action: light.turn_on
      target:
        entity_id: light.bedroom_overhead_left
      data:
        effect: sunrise
    - action: light.turn_on
      target:
        entity_id: light.bedroom_overhead_right
      data:
        effect: sunrise


# Bedroom - dim warm at night, adaptive during day
bedroom_lights:
  alias: "Bedroom Lights"
  description: "Bedroom adaptive lighting with dim warm night mode"
  icon: mdi:bed
  mode: single
  sequence:
    - action: script.lights
      data:
        lights:
          - light.bedroom_lamp
          - light.bedroom_overhead_left
          - light.bedroom_overhead_right
        night_mode: dim_warm
        night_brightness: 10


# Bathroom - uses dim pink RGB at night, only strip light
bathroom_lights:
  alias: "Bathroom Lights"
  description: "Bathroom adaptive lighting with pink night mode"
  icon: mdi:toilet
  mode: single
  sequence:
    - action: script.lights
      data:
        lights:
          - light.bathroom_lamp
          - light.bathroom_strip
        night_mode: dim_rgb
        night_lights:
          - light.bathroom_strip
        night_rgb: [255, 159, 242]
        night_brightness: 10


# =============================================================================
# TV Time - Adaptive ambient lighting for watching TV
# =============================================================================
# Context: TV on left wall, Dad's chair on right facing TV, sliding glass
# doors to right of chair. Living room light causes glare, kitchen lights don't.
#
# Behavior by sun/time:
#   - Daytime (sun elevation > 5°): No changes (natural light sufficient)
#   - Evening (sun elevation <= 5°, before 11pm): Dim warm ambient in kitchen
#   - Late night (11pm-6am): Even dimmer, just kitchen strip
#
# Always:
#   - Living room light OFF (causes glare)
#   - Bedroom lights OFF
#   - Kitchen counter switch OFF
#
# Charlie presence:
#   - When Charlie is home, kitchen lights are NOT adjusted (he may be eating/playing)

tv_time:
  alias: "TV Time"
  description: "Smart ambient lighting for TV watching based on sun position"
  icon: mdi:television-ambient-light
  mode: single
  fields:
    transition:
      name: Transition
      description: "Transition duration in seconds"
      default: 11
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: "seconds"
  sequence:
    - variables:
        sun_elevation: "{{ state_attr('sun.sun', 'elevation') | float(0) }}"
        hour: "{{ now().hour }}"
        trans: "{{ transition | default(states('input_number.tv_time_transition_duration') | int(11)) }}"
        # Daytime: sun is high enough for natural light
        is_daytime: "{{ sun_elevation > 5 }}"
        # Late night: after 11pm or before 6am
        is_late_night: "{{ hour >= 23 or hour < 6 }}"
        # Evening: sun is low/set but not late night yet
        is_evening: "{{ not is_daytime and not is_late_night }}"
        # Warm amber - cozy without being distracting
        ambient_color: [255, 180, 107]
        # Charlie meal zone - protect island bulb when FP2 detects presence
        charlie_meal_active: "{{ is_state('binary_sensor.charlie_meal', 'on') }}"

    # Always turn off glare-causing lights
    - action: light.turn_off
      target:
        entity_id:
          - light.living_room_light
          - light.living_room_overhead_light
          - light.bedroom_lamp
          - light.bedroom_overhead_left
          - light.bedroom_overhead_right
      data:
        transition: "{{ trans }}"

    - action: switch.turn_off
      target:
        entity_id: switch.kitchen_counter_switch

    - choose:
        # Daytime: Turn off kitchen lights (no ambient needed, reduce distraction)
        - conditions: "{{ is_daytime }}"
          sequence:
            - action: light.turn_off
              target:
                entity_id:
                  - light.sink_bulb
                  - light.hue_lightstrip_plus_1
              data:
                transition: "{{ trans }}"
            - if:
                - condition: template
                  value_template: "{{ not charlie_meal_active }}"
              then:
                - action: light.turn_off
                  target:
                    entity_id: light.island_bulb
                  data:
                    transition: "{{ trans }}"

        # Late night: Very dim, just the strip
        - conditions: "{{ is_late_night }}"
          sequence:
            - action: light.turn_off
              target:
                entity_id: light.sink_bulb
              data:
                transition: "{{ trans }}"
            - if:
                - condition: template
                  value_template: "{{ not charlie_meal_active }}"
              then:
                - action: light.turn_off
                  target:
                    entity_id: light.island_bulb
                  data:
                    transition: "{{ trans }}"
            - action: light.turn_on
              target:
                entity_id: light.hue_lightstrip_plus_1
              data:
                brightness_pct: 3
                rgb_color: "{{ ambient_color }}"
                transition: "{{ trans }}"

      # Evening (default): Dim warm ambient in kitchen
      default:
        - action: light.turn_on
          target:
            entity_id:
              - light.sink_bulb
              - light.hue_lightstrip_plus_1
          data:
            brightness_pct: 15
            rgb_color: "{{ ambient_color }}"
            transition: "{{ trans }}"
        - if:
            - condition: template
              value_template: "{{ not charlie_meal_active }}"
          then:
            - action: light.turn_on
              target:
                entity_id: light.island_bulb
              data:
                brightness_pct: 15
                rgb_color: "{{ ambient_color }}"
                transition: "{{ trans }}"


# =============================================================================
# Kitchen Chill - Relaxed ambient lighting for kitchen
# =============================================================================
# A "chill" mode that's warmer and dimmer than normal kitchen lighting.
# Good for casual hanging out, not task lighting.
#
# Behavior:
#   - Daytime: Adaptive brightness (capped at 60%) with warm color temp (capped at 3000K)
#   - Night (11pm-6am): Very dim warm, just the strip light
#   - Counter switch always OFF (no task lighting)

kitchen_chill:
  alias: "Kitchen Chill"
  description: "Relaxed kitchen ambient lighting - warmer and dimmer than normal"
  icon: mdi:sofa
  mode: single
  sequence:
    - variables:
        adaptive_brightness: "{{ states('sensor.adaptive_brightness') | int(50) }}"
        adaptive_color_temp: "{{ states('sensor.adaptive_color_temp') | int(3000) }}"
        hour: "{{ now().hour }}"
        is_night: "{{ hour >= 23 or hour < 6 }}"
        # Use full adaptive brightness (no cap)
        chill_brightness: "{{ adaptive_brightness }}"
        # Cap color temp at 3000K (warmer = more chill)
        chill_color_temp: "{{ [adaptive_color_temp, 3000] | min }}"

    # Always turn off counter switch (task lighting)
    - action: switch.turn_off
      target:
        entity_id: switch.kitchen_counter_switch

    - choose:
        # Night: Very dim, just the strip
        - conditions: "{{ is_night }}"
          sequence:
            - action: light.turn_off
              target:
                entity_id:
                  - light.island_bulb
                  - light.sink_bulb
            - action: light.turn_on
              target:
                entity_id: light.hue_lightstrip_plus_1
              data:
                brightness_pct: 10
                color_temp_kelvin: 2200

      # Daytime/evening: Chill ambient across kitchen
      default:
        - action: light.turn_on
          target:
            entity_id: light.kitchen_lights
          data:
            brightness_pct: "{{ chill_brightness }}"
            color_temp_kelvin: "{{ chill_color_temp }}"


# =============================================================================
# Good Morning - Adaptive wake-up lighting
# =============================================================================
# Lights up the home for morning routine, adapting to sunrise time.
#
# Behavior:
#   - If sun is up (elevation > 5°): Minimal lighting, let natural light in
#   - If sun is rising (elevation -5° to 5°): Moderate warm light
#   - If sun is down (elevation < -5°): Bright warm light to simulate sunrise
#
# Rooms affected:
#   - Kitchen: Adaptive brightness, warm color
#   - Living room: Dim warm ambient
#   - Bedroom: Dim warm (in case still waking up)
#   - Charlie's room: Only when Charlie is home (shapes light)

good_morning:
  alias: "Good Morning"
  description: "Wake-up lighting that adapts to sunrise - brighter in winter, dimmer when sun is up"
  icon: mdi:weather-sunset-up
  mode: single
  sequence:
    - variables:
        sun_elevation: "{{ state_attr('sun.sun', 'elevation') | float(0) }}"
        # Sun states: up (>5°), rising (-5° to 5°), down (<-5°)
        sun_is_up: "{{ sun_elevation > 5 }}"
        sun_is_rising: "{{ sun_elevation >= -5 and sun_elevation <= 5 }}"
        sun_is_down: "{{ sun_elevation < -5 }}"
        # When sun is up, use very low brightness; when down, gentle wake-up
        # Kitchen/living room only when sun is rising/up (presence handles them otherwise)
        kitchen_brightness: >
          {% if sun_is_up %}30 {% elif sun_is_rising %}50 {% else %}0{% endif %}
        living_brightness: >
          {% if sun_is_up %}20 {% elif sun_is_rising %}35 {% else %}0{% endif %}
        bedroom_brightness: >
          {% if sun_is_up %}15 {% elif sun_is_rising %}25 {% else %}25{% endif %}
        # Warmer when dark, cooler as sun rises
        color_temp: >
          {% if sun_is_up %}3500 {% elif sun_is_rising %}2800 {% else %}2400{% endif %}
        # Charlie presence
        charlie_is_home: "{{ is_state('input_boolean.charlie_presence', 'on') }}"

    # Kitchen - only when sun is rising/up (presence handles dark mornings)
    - if:
        - condition: template
          value_template: "{{ kitchen_brightness > 0 }}"
      then:
        - action: light.turn_on
          target:
            entity_id: light.kitchen_lights
          data:
            brightness_pct: "{{ kitchen_brightness }}"
            color_temp_kelvin: "{{ color_temp }}"

    # Living room - only when sun is rising/up (presence handles dark mornings)
    - if:
        - condition: template
          value_template: "{{ living_brightness > 0 }}"
      then:
        - action: light.turn_on
          target:
            entity_id:
              - light.living_room_light
              - light.living_room_overhead_light
          data:
            brightness_pct: "{{ living_brightness }}"
            color_temp_kelvin: "{{ color_temp }}"

    # Bedroom - gentle in case still waking up
    - action: light.turn_on
      target:
        entity_id:
          - light.bedroom_lamp
          - light.bedroom_overhead_left
          - light.bedroom_overhead_right
      data:
        brightness_pct: "{{ bedroom_brightness }}"
        color_temp_kelvin: "{{ color_temp }}"

    # Charlie's room - only when he's home
    - if:
        - condition: template
          value_template: "{{ charlie_is_home }}"
      then:
        - action: light.turn_on
          target:
            entity_id: light.charlie_s_shapes
          data:
            brightness_pct: "{{ bedroom_brightness }}"
            color_temp_kelvin: "{{ color_temp }}"


# =============================================================================
# Eating - Adaptive dining ambiance
# =============================================================================
# Cozy ambient lighting for meals. Kitchen task lights off, living room
# provides warm ambient light for the dining area.
#
# Behavior by sun/time:
#   - Daytime (sun elevation > 5°): Minimal lighting, natural light sufficient
#   - Evening (sun <= 5°, before 11pm): Warm ambient in living room
#   - Late night (11pm-6am): Very dim warm
#
# Always:
#   - Kitchen lights OFF (dining focus, not cooking)
#   - Counter switch OFF

eating:
  alias: "Eating"
  description: "Cozy dining ambiance - warm living room light, kitchen off"
  icon: mdi:food-fork-drink
  mode: single
  sequence:
    - variables:
        sun_elevation: "{{ state_attr('sun.sun', 'elevation') | float(0) }}"
        hour: "{{ now().hour }}"
        # Daytime: sun is high enough for natural light
        is_daytime: "{{ sun_elevation > 5 }}"
        # Late night: after 11pm or before 6am
        is_late_night: "{{ hour >= 23 or hour < 6 }}"
        # Evening brightness based on sun position (dimmer as sun sets further)
        evening_brightness: >
          {% if sun_elevation > 0 %}35 {% elif sun_elevation > -5 %}30 {% elif sun_elevation > -10 %}25 {% else %}20{% endif %}
        # Very warm for dining ambiance
        color_temp: 2200

    # Always turn off kitchen (focus on dining, not cooking)
    - action: light.turn_off
      target:
        entity_id: light.kitchen_lights

    - action: switch.turn_off
      target:
        entity_id: switch.kitchen_counter_switch

    - choose:
        # Daytime: minimal lighting, let natural light do the work
        - conditions: "{{ is_daytime }}"
          sequence:
            - action: light.turn_on
              target:
                entity_id:
                  - light.living_room_light
                  - light.living_room_overhead_light
              data:
                brightness_pct: 15
                color_temp_kelvin: 2700

        # Late night: very dim
        - conditions: "{{ is_late_night }}"
          sequence:
            - action: light.turn_on
              target:
                entity_id:
                  - light.living_room_light
                  - light.living_room_overhead_light
              data:
                brightness_pct: 10
                color_temp_kelvin: 2200

      # Evening: warm ambient based on sun position
      default:
        - action: light.turn_on
          target:
            entity_id:
              - light.living_room_light
              - light.living_room_overhead_light
          data:
            brightness_pct: "{{ evening_brightness }}"
            color_temp_kelvin: "{{ color_temp }}"


# =============================================================================
# Winding Down - Pre-bedtime adaptive lighting
# =============================================================================
# Relaxed evening lighting to prepare for sleep. All lights dim and warm.
#
# Behavior:
#   - Uses adaptive sensors but caps brightness at 35% and color temp at 2200K
#   - Kitchen counter switch always off (no bright task lighting)
#   - Creates a calm, sleepy atmosphere across all main rooms
#   - Charlie's room: Only when Charlie is home (shapes light dimmed)

winding_down:
  alias: "Winding Down"
  description: "Pre-bedtime lighting - dim warm across all rooms"
  icon: mdi:weather-sunset-down
  mode: single
  sequence:
    - variables:
        adaptive_brightness: "{{ states('sensor.adaptive_brightness') | int(25) }}"
        # Cap brightness at 35% for winding down
        capped_brightness: "{{ [adaptive_brightness, 35] | min }}"
        # Very warm color temp, capped at 2200K
        color_temp: 2200
        # Charlie presence
        charlie_is_home: "{{ is_state('input_boolean.charlie_presence', 'on') }}"

    # Turn off task lighting
    - action: switch.turn_off
      target:
        entity_id: switch.kitchen_counter_switch

    # Kitchen - dim warm ambient
    - action: light.turn_on
      target:
        entity_id: light.kitchen_lights
      data:
        brightness_pct: "{{ capped_brightness }}"
        color_temp_kelvin: "{{ color_temp }}"

    # Living room - dim warm
    - action: light.turn_on
      target:
        entity_id:
          - light.living_room_light
          - light.living_room_overhead_light
      data:
        brightness_pct: "{{ capped_brightness }}"
        color_temp_kelvin: "{{ color_temp }}"

    # Bedroom - slightly brighter for bedtime routine
    - action: light.turn_on
      target:
        entity_id:
          - light.bedroom_lamp
          - light.bedroom_overhead_left
          - light.bedroom_overhead_right
      data:
        brightness_pct: "{{ [capped_brightness + 5, 40] | min }}"
        color_temp_kelvin: "{{ color_temp }}"

    # Charlie's room - only when he's home, dim warm for bedtime
    - if:
        - condition: template
          value_template: "{{ charlie_is_home }}"
      then:
        - action: light.turn_on
          target:
            entity_id: light.charlie_s_shapes
          data:
            brightness_pct: "{{ capped_brightness }}"
            color_temp_kelvin: "{{ color_temp }}"


# =============================================================================
# Arriving Home - Adaptive lighting for arrival (kitchen/living room only)
# =============================================================================
# A welcoming lighting scene for when arriving home. Similar to kitchen_chill
# but includes living room. Designed to be used by arrival automations.
#
# Behavior by sun/time:
#   - Daytime (sun elevation > 5°): Minimal lighting (natural light sufficient)
#   - Evening (sun <= 5°, before 11pm): Warm adaptive in kitchen + living room
#   - Late night (11pm-6am): Very dim warm
#
# Always:
#   - Kitchen counter switch OFF (no harsh task lighting)
#   - Bedroom lights untouched (might be sleeping)
#   - Charlie's room untouched

arriving_home:
  alias: "Arriving Home"
  description: "Welcoming adaptive lighting for arrival - kitchen only"
  icon: mdi:home-import-outline
  mode: single
  sequence:
    - variables:
        sun_elevation: "{{ state_attr('sun.sun', 'elevation') | float(0) }}"
        adaptive_brightness: "{{ states('sensor.adaptive_brightness') | int(50) }}"
        adaptive_color_temp: "{{ states('sensor.adaptive_color_temp') | int(3000) }}"
        hour: "{{ now().hour }}"
        # Daytime: sun is high enough for natural light
        is_daytime: "{{ sun_elevation > 5 }}"
        # Late night: after 11pm or before 6am
        is_late_night: "{{ hour >= 23 or hour < 6 }}"
        # Cap brightness at 60% for chill vibe
        chill_brightness: "{{ [adaptive_brightness, 60] | min }}"
        # Cap color temp at 3000K (warmer = more welcoming)
        chill_color_temp: "{{ [adaptive_color_temp, 3000] | min }}"

    # Always turn off counter switch (no harsh task lighting when arriving)
    - action: switch.turn_off
      target:
        entity_id: switch.kitchen_counter_switch

    - choose:
        # Daytime: Minimal lighting, let natural light do the work
        - conditions: "{{ is_daytime }}"
          sequence:
            - action: light.turn_on
              target:
                entity_id: light.kitchen_lights
              data:
                brightness_pct: 25
                color_temp_kelvin: 3000

        # Late night: Very dim warm
        - conditions: "{{ is_late_night }}"
          sequence:
            - action: light.turn_off
              target:
                entity_id:
                  - light.island_bulb
                  - light.sink_bulb
            - action: light.turn_on
              target:
                entity_id: light.hue_lightstrip_plus_1
              data:
                brightness_pct: 10
                color_temp_kelvin: 2200

      # Evening (default): Warm adaptive in kitchen
      default:
        - action: light.turn_on
          target:
            entity_id: light.kitchen_lights
          data:
            brightness_pct: "{{ chill_brightness }}"
            color_temp_kelvin: "{{ chill_color_temp }}"


# =============================================================================
# Charlie Eating - Focused island light for Charlie's meals
# =============================================================================
# Simple lighting for when Charlie is eating at the island.
# Just the island bulb on, everything else in kitchen off.
#
# Behavior:
#   - Island bulb: adaptive brightness/color temp
#   - All other kitchen lights: OFF
#   - Counter switch: OFF
#
# This avoids distractions and keeps focus on the eating area.

# =============================================================================
# Bruins Animation - Rotating black & gold through kitchen lights
# =============================================================================
# Cycles the Bruins colors (gold and dark brown "black") through the three
# kitchen lights in a rotating pattern.
#
# Pattern:
#   Step 1: Island=gold, Sink=black, Strip=black
#   Step 2: Island=black, Sink=gold, Strip=black
#   Step 3: Island=black, Sink=black, Strip=gold
#   (repeats)
#
# Use script.turn_off to stop the animation.

bruins_animation:
  alias: "Bruins Animation"
  description: "Rotating black & gold animation through kitchen lights"
  icon: mdi:hockey-puck
  mode: restart
  fields:
    delay_seconds:
      name: Delay
      description: "Seconds between each color change"
      default: 10
      selector:
        number:
          min: 0.5
          max: 30
          step: 0.5
          unit_of_measurement: "seconds"
    cycles:
      name: Cycles
      description: "Number of full rotations (0 = infinite)"
      default: 0
      selector:
        number:
          min: 0
          max: 100
  sequence:
    - variables:
        gold_hs: [43, 89]
        black_hs: [30, 100]
        gold_brightness: 255
        black_brightness: 30
        delay_sec: "{{ delay_seconds | default(10) | float }}"
        max_cycles: "{{ cycles | default(0) | int }}"
    - repeat:
        while:
          - condition: template
            value_template: "{{ max_cycles == 0 or repeat.index <= max_cycles }}"
        sequence:
          # Step 1: Island=gold, Sink=black, Strip=black
          - action: light.turn_on
            target:
              entity_id: light.island_bulb
            data:
              brightness: "{{ gold_brightness }}"
              hs_color: "{{ gold_hs }}"
          - action: light.turn_on
            target:
              entity_id: light.sink_bulb
            data:
              brightness: "{{ black_brightness }}"
              hs_color: "{{ black_hs }}"
          - action: light.turn_on
            target:
              entity_id: light.hue_lightstrip_plus_1
            data:
              brightness: "{{ black_brightness }}"
              hs_color: "{{ black_hs }}"
          - delay:
              seconds: "{{ delay_sec }}"

          # Step 2: Island=black, Sink=gold, Strip=black
          - action: light.turn_on
            target:
              entity_id: light.island_bulb
            data:
              brightness: "{{ black_brightness }}"
              hs_color: "{{ black_hs }}"
          - action: light.turn_on
            target:
              entity_id: light.sink_bulb
            data:
              brightness: "{{ gold_brightness }}"
              hs_color: "{{ gold_hs }}"
          - action: light.turn_on
            target:
              entity_id: light.hue_lightstrip_plus_1
            data:
              brightness: "{{ black_brightness }}"
              hs_color: "{{ black_hs }}"
          - delay:
              seconds: "{{ delay_sec }}"

          # Step 3: Island=black, Sink=black, Strip=gold
          - action: light.turn_on
            target:
              entity_id: light.island_bulb
            data:
              brightness: "{{ black_brightness }}"
              hs_color: "{{ black_hs }}"
          - action: light.turn_on
            target:
              entity_id: light.sink_bulb
            data:
              brightness: "{{ black_brightness }}"
              hs_color: "{{ black_hs }}"
          - action: light.turn_on
            target:
              entity_id: light.hue_lightstrip_plus_1
            data:
              brightness: "{{ gold_brightness }}"
              hs_color: "{{ gold_hs }}"
          - delay:
              seconds: "{{ delay_sec }}"


charlie_eating:
  alias: "Charlie Eating"
  description: "Island light only for Charlie's meals - kitchen lights off"
  icon: mdi:baby-face-outline
  mode: single
  sequence:
    - variables:
        adaptive_brightness: "{{ states('sensor.adaptive_brightness') | int(50) }}"
        color_temp: "{{ states('sensor.adaptive_color_temp') | int(3000) }}"
        hour: "{{ now().hour }}"
        is_night: "{{ hour >= 23 or hour < 6 }}"
        # Minimum 50% brightness for task lighting
        brightness: "{{ [adaptive_brightness, 50] | max }}"

    # Turn off all kitchen lights except island bulb
    - action: light.turn_off
      target:
        entity_id:
          - light.sink_bulb
          - light.hue_lightstrip_plus_1

    # Turn off counter switch
    - action: switch.turn_off
      target:
        entity_id: switch.kitchen_counter_switch

    - choose:
        # Late night: dim warm
        - conditions: "{{ is_night }}"
          sequence:
            - action: light.turn_on
              target:
                entity_id: light.island_bulb
              data:
                brightness_pct: 20
                color_temp_kelvin: 2200

      # Default: adaptive
      default:
        - action: light.turn_on
          target:
            entity_id: light.island_bulb
          data:
            brightness_pct: "{{ brightness }}"
            color_temp_kelvin: "{{ color_temp }}"


# =============================================================================
# Charlie Presence Scripts
# =============================================================================
# Simple scripts to manually set Charlie's presence status.
# Useful when phone tracking fails (e.g., phone turned off).

charlies_home:
  alias: "Charlie's Home"
  description: "Mark Charlie as home"
  icon: mdi:account-plus
  mode: single
  sequence:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.charlie_presence

charlies_away:
  alias: "Charlie's Away"
  description: "Mark Charlie as away"
  icon: mdi:account-minus
  mode: single
  sequence:
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.charlie_presence


# =============================================================================
# Lock Down - Bedtime security and shutdown
# =============================================================================
# Comprehensive bedtime routine: lock door, turn off lights and media.
# Triggered by long-press of bedroom button.

lock_down:
  alias: "Lock Down"
  description: "Bedtime lock down: lock door, turn off lights and media"
  icon: mdi:shield-lock
  mode: single
  sequence:
    - parallel:
        - action: lock.lock
          target:
            entity_id: lock.nuki_smart_lock
        - action: scene.turn_on
          target:
            entity_id: scene.lights_out
        - action: media_player.turn_off
          target:
            entity_id:
              - media_player.lg_webos_tv_oled65c3aua
              - media_player.living_room


# =============================================================================
# Airversa Purge - Run max fan speed purge cycle
# =============================================================================
# Runs the air purifier at max fan speed (100%) for 15 minutes to quickly
# clean the air, then returns to automatic mode.
#
# Used by arrival automation to clean air after returning home.
# Updates last_purge timestamp to enable 12-hour debounce.

airversa_purge:
  alias: "Airversa Purge"
  description: "Run max fan for 15 min then back to auto"
  icon: mdi:air-purifier
  mode: single
  sequence:
    # Record purge start time
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.airversa_last_purge
      data:
        datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

    # Set to manual mode
    - action: select.select_option
      target:
        entity_id: select.airversa_ap2_1120_air_purifier_mode
      data:
        option: manual

    # Set fan to max (100%)
    - action: fan.set_percentage
      target:
        entity_id: fan.airversa_ap2_1120_airpurifier
      data:
        percentage: 100

    # Wait 15 minutes
    - delay:
        minutes: 15

    # Return to automatic mode
    - action: select.select_option
      target:
        entity_id: select.airversa_ap2_1120_air_purifier_mode
      data:
        option: automatic


# =============================================================================
# Clean Charlie's Room - Vacuum Charlie's bedroom, bathroom, and closet
# =============================================================================
# Sends the Roborock vacuum to clean Charlie's areas.
#
# Roborock room segment mapping (roborock.get_maps):
#   16: Dad's Closet
#   17: Laundry
#   18: Charlie's Closet
#   19: Kitchen
#   20: Charlie's Bathroom
#   21: Charlie's Bedroom
#   22: Living Room
#   23: Dad's Bedroom
#   24: Dad's Bathroom

clean_charlies_room:
  alias: "Clean Charlie's Room"
  description: "Vacuum Charlie's bedroom, bathroom, and closet"
  icon: mdi:robot-vacuum
  mode: single
  sequence:
    - action: vacuum.send_command
      target:
        entity_id: vacuum.roborock_q5_max
      data:
        command: app_segment_clean
        params:
          - 21  # Charlie's Bedroom
          - 20  # Charlie's Bathroom
          - 18  # Charlie's Closet


# =============================================================================
# Done Shaving - Vacuum Dad's Bathroom
# =============================================================================
# Trigger after shaving to clean up hair clippings from the bathroom floor.
# Sends the Roborock vacuum to clean Dad's bathroom only.

done_shaving:
  alias: "Done Shaving"
  description: "Vacuum Dad's bathroom after shaving"
  icon: mdi:face-man-shimmer
  mode: single
  sequence:
    - action: vacuum.send_command
      target:
        entity_id: vacuum.roborock_q5_max
      data:
        command: app_segment_clean
        params:
          - 24  # Dad's Bathroom
