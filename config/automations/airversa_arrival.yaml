id: "1766336370065"
alias: "Airversa Arrival"
description: >-
  Turn on air purifier and run purge cycle when Dad arrives home.
  Purge only runs if more than 12 hours since last purge.
triggers:
  - trigger: zone
    entity_id: person.john_allen
    zone: zone.home
    event: enter
actions:
  # Turn on purifier
  - action: fan.turn_on
    target:
      entity_id: fan.airversa_ap2_1120_airpurifier

  # Set to automatic mode initially
  - action: select.select_option
    target:
      entity_id: select.airversa_ap2_1120_air_purifier_mode
    data:
      option: automatic

  # Run purge if more than 12 hours since last purge
  - if:
      - condition: template
        value_template: >-
          {% set last_purge = states('input_datetime.airversa_last_purge') %}
          {% if last_purge in ['unknown', 'unavailable', 'None'] %}
            true
          {% else %}
            {% set last_dt = as_datetime(last_purge) %}
            {% set hours_since = (now() - last_dt).total_seconds() / 3600 %}
            {{ hours_since > 12 }}
          {% endif %}
    then:
      - action: script.airversa_purge
mode: single
