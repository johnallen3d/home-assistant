# Living Room Presence Lighting
# Turns living room lights on/off based on FP2 presence sensor living room zone
#
# On entry: Uses adaptive lighting with overhead 15% dimmer than main light
# On exit: Turns lights off immediately (no delay)

id: '1765490534742'
alias: "Living Room Presence Lighting"
description: "Adaptive living room lights based on FP2 presence detection"
mode: single

triggers:
  - trigger: state
    entity_id: binary_sensor.kitchen_presence_living_room
    to: "on"
    id: presence_on
  - trigger: state
    entity_id: binary_sensor.kitchen_presence_living_room
    to: "off"
    id: presence_off

actions:
  - choose:
      # Presence detected - turn on with adaptive lighting (but not if TV is on)
      - conditions:
          - condition: trigger
            id: presence_on
          # Check Apple TV, LG TV, and SuperBOX - skip if any is in use
          # Apple TV: playing/paused/idle = in use; off/unavailable = not in use
          # LG TV: on/playing = in use; off/unavailable = not in use
          # SuperBOX: on = in use; off/unavailable = not in use
          - condition: template
            value_template: >-
              {{ states('media_player.living_room') in ['off', 'unavailable']
                 and states('media_player.lg_webos_tv_oled65c3aua') in ['off', 'unavailable']
                 and states('media_player.superbox') in ['off', 'unavailable'] }}
        sequence:
          - variables:
              brightness: "{{ states('sensor.adaptive_brightness') | int(50) }}"
              color_temp: "{{ states('sensor.adaptive_color_temp') | int(3000) }}"
              hour: "{{ now().hour }}"
              is_night: "{{ hour >= 23 or hour < 6 }}"
              # Overhead is 15 percentage points dimmer than main light
              overhead_brightness: "{{ [brightness - 15, 5] | max }}"
              night_brightness: 15
              overhead_night_brightness: "{{ [night_brightness - 15, 5] | max }}"
          - choose:
              # Night mode: dim warm
              - conditions: "{{ is_night }}"
                sequence:
                  - action: light.turn_on
                    target:
                      entity_id: light.living_room_light
                    data:
                      brightness_pct: "{{ night_brightness }}"
                      color_temp_kelvin: 2200
                  - action: light.turn_on
                    target:
                      entity_id: light.living_room_overhead_light
                    data:
                      brightness_pct: "{{ overhead_night_brightness }}"
                      color_temp_kelvin: 2200
            # Default: adaptive mode
            default:
              - action: light.turn_on
                target:
                  entity_id: light.living_room_light
                data:
                  brightness_pct: "{{ brightness }}"
                  color_temp_kelvin: "{{ color_temp }}"
              - action: light.turn_on
                target:
                  entity_id: light.living_room_overhead_light
                data:
                  brightness_pct: "{{ overhead_brightness }}"
                  color_temp_kelvin: "{{ color_temp }}"

      # Presence cleared - turn off (unless hobby mode, eating mode, or TV is on)
      - conditions:
          - condition: trigger
            id: presence_off
        sequence:
          # Skip if hobby mode is on (user is working on a project)
          - condition: state
            entity_id: input_boolean.hobby_mode
            state: "off"
          # Skip if eating mode is on (Charlie's meal in progress)
          - condition: state
            entity_id: input_boolean.eating_mode
            state: "off"
          # Skip if dad eating mode is on (Dad's meal in progress)
          - condition: state
            entity_id: input_boolean.dad_eating_mode
            state: "off"
          # Skip if TV is in use (tv_time script handles lighting)
          # Check Apple TV, LG TV, and SuperBOX
          - condition: template
            value_template: >-
              {{ states('media_player.living_room') in ['off', 'unavailable']
                 and states('media_player.lg_webos_tv_oled65c3aua') in ['off', 'unavailable']
                 and states('media_player.superbox') in ['off', 'unavailable'] }}
          - action: light.turn_off
            target:
              entity_id: light.living_room_lights
