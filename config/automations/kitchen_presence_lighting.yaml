# Kitchen Presence Lighting
# Turns kitchen lights on/off based on FP2 presence sensor kitchen zone
#
# On entry: Uses adaptive lighting script for time-appropriate brightness/color
# On exit: Turns lights off after presence_delay seconds (unless presence returns or cooking_mode is active)
#
# Note: Charlie Meal zone is inside Kitchen zone. Island light is shared:
# - Kitchen turns it ON (via kitchen_lights group)
# - Kitchen turns it OFF only if charlie_meal is also clear
# - Charlie Meal automation handles island when charlie_meal zone is active
#
# Cooking Mode: When input_boolean.cooking_mode is ON, lights are NOT turned off.
# This protects against the FP2 coverage gap at the oven.

id: '1765490530767'
alias: "Kitchen Presence Lighting"
description: "Adaptive kitchen lights based on FP2 presence detection"
mode: single

triggers:
  - trigger: state
    entity_id: binary_sensor.kitchen_presence_kitchen
    to: "on"
    id: presence_on
  - trigger: state
    entity_id: binary_sensor.kitchen_presence_kitchen
    to: "off"
    id: presence_off

actions:
  - choose:
      # Presence detected - turn on with adaptive lighting (only if lights are off)
      - conditions:
          - condition: trigger
            id: presence_on
        sequence:
          # Only proceed if lights are actually off
          - if:
              - condition: state
                entity_id: light.sink_bulb
                state: "off"
            then:
              - action: script.lights
                data:
                  lights:
                    - light.kitchen_lights
                  night_mode: dim_warm
                  night_brightness: 15

      # Presence cleared - turn off after presence_delay seconds (unless presence returns or cooking/eating mode is on)
      - conditions:
          - condition: trigger
            id: presence_off
        sequence:
          # If cooking_mode is on, don't turn off lights (oven coverage gap protection)
          - condition: state
            entity_id: input_boolean.cooking_mode
            state: "off"
          # If eating_mode is on, don't turn off lights
          - condition: state
            entity_id: input_boolean.eating_mode
            state: "off"
          - wait_for_trigger:
              - trigger: state
                entity_id: binary_sensor.kitchen_presence_kitchen
                to: "on"
            timeout:
              seconds: "{{ states('input_number.presence_delay') | int(5) }}"
          - if:
              - condition: template
                value_template: "{{ wait.trigger is none }}"
            then:
              # Always turn off sink, lightstrip, and counter switch
              - action: light.turn_off
                target:
                  entity_id:
                    - light.sink_bulb
                    - light.hue_lightstrip_plus_1
              - action: switch.turn_off
                target:
                  entity_id: switch.kitchen_counter_switch
              # Turn off island only if charlie_meal zone is also clear AND eating_mode is off
              - if:
                  - condition: state
                    entity_id: binary_sensor.charlie_meal
                    state: "off"
                  - condition: state
                    entity_id: input_boolean.eating_mode
                    state: "off"
                then:
                  - action: light.turn_off
                    target:
                      entity_id: light.island_bulb
