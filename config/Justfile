# Home Assistant Configuration Management

# Import server config from .env (loaded by root Justfile)
server := env_var('HA_SERVER')
config_path := env_var('HA_CONFIG_PATH')

# Default recipe - show help
default:
    @just --list

# Extract config files from HA server and split into individual files
extract:
    @echo "ğŸ“¥ Extracting configuration from Home Assistant..."
    @./extract.sh

# Alias for extract
pull: extract

# Upload configuration.yaml to HA server and re-sync
upload-config:
    @echo "ğŸ“¤ Uploading configuration.yaml..."
    @scp configuration.yaml {{server}}:{{config_path}}/configuration.yaml
    @echo "âœ… Configuration uploaded"
    @echo "ğŸ”„ Re-syncing local copy..."
    @./extract.sh

# Update a specific automation: pull from server, update from local file, push back, then re-sync
# Usage: just config::update-automation automations/bathroom_presence.yaml
update-automation FILE:
    @echo "ğŸ”§ Updating automation from {{FILE}}..."
    @uv run --directory .. update_automation.py {{FILE}}
    @echo "ğŸ”„ Re-syncing local copy..."
    @./extract.sh

# Update multiple automations at once
# Usage: just config::update-automations "automations/bathroom_presence.yaml automations/kitchen_button.yaml"
update-automations FILES:
    @echo "ğŸ”§ Updating automations..."
    @uv run --directory .. update_automation.py {{FILES}}
    @echo "ğŸ”„ Re-syncing local copy..."
    @./extract.sh

# Alias for update-automation
push-automation FILE: (update-automation FILE)

# Restart Home Assistant core (takes ~30s)
restart:
    @echo "ğŸ”„ Restarting Home Assistant core..."
    @ssh {{server}} "ha core restart" || true
    @echo "â³ Waiting 30s for restart..."
    @sleep 30
    @ssh {{server}} "ha info | head -3"
    @echo "âœ… Home Assistant restarted"

# Full workflow: upload config and restart
deploy: upload-config restart
    @echo "âœ… Configuration deployed and Home Assistant restarted"

# Check HA server status
status:
    @echo "ğŸ“Š Home Assistant status:"
    @ssh {{server}} "ha info"

# Show HA core logs
logs:
    @echo "ğŸ“‹ Streaming Home Assistant logs..."
    @ssh {{server}} "ha core logs -f"

# Backup current automations on server
backup:
    @echo "ğŸ’¾ Backing up automations..."
    @ssh {{server}} "cp {{config_path}}/automations.yaml {{config_path}}/automations.yaml.backup"
    @echo "âœ… Backup created: automations.yaml.backup"

# Show info about configuration
info:
    @echo "Server: {{server}}"
    @echo "Config path: {{config_path}}"
    @echo "Local automations: $(ls automations/*.yaml | wc -l | tr -d ' ') files"

# Create a new helper (input_number) in configuration.yaml
# Usage: just config::create-helper laundry_room_motion_delay "Laundry Room Motion Delay" 1 60 1 seconds 5
create-helper NAME DISPLAY_NAME MIN MAX STEP UNIT INITIAL:
    @echo "ğŸ”§ Creating helper '{{NAME}}'..."
    @echo "  {{NAME}}:" >> configuration.yaml
    @echo "    name: {{DISPLAY_NAME}}" >> configuration.yaml
    @echo "    min: {{MIN}}" >> configuration.yaml
    @echo "    max: {{MAX}}" >> configuration.yaml
    @echo "    step: {{STEP}}" >> configuration.yaml
    @echo "    unit_of_measurement: {{UNIT}}" >> configuration.yaml
    @echo "    icon: mdi:timer-outline" >> configuration.yaml
    @echo "    initial: {{INITIAL}}" >> configuration.yaml
    @echo "âœ… Helper '{{NAME}}' added to configuration.yaml"
    @echo "âš ï¸  Don't forget to run 'just config::upload-config' to deploy"

# Create local blueprints directory if it doesn't exist
init-blueprints:
    @mkdir -p blueprints/automation
    @echo "âœ… Blueprints directory created"

# Upload a blueprint to HA server
# Usage: just config::upload-blueprint blueprints/automation/my_blueprint.yaml
upload-blueprint FILE:
    @echo "ğŸ“¤ Uploading blueprint {{FILE}}..."
    @ssh {{server}} "mkdir -p {{config_path}}/blueprints/automation"
    @scp {{FILE}} {{server}}:{{config_path}}/{{FILE}}
    @echo "âœ… Blueprint uploaded"

# Pull all blueprints from server
pull-blueprints:
    @echo "ğŸ“¥ Downloading blueprints from server..."
    @mkdir -p blueprints/automation
    @scp -r {{server}}:{{config_path}}/blueprints/automation/*.yaml blueprints/automation/ 2>/dev/null || echo "No custom blueprints found on server"
    @echo "âœ… Blueprints synced"

# ============================================
# Dashboard Management
# ============================================

# Pull all dashboards from server (lovelace.dashboard_* files)
pull-dashboards:
    @echo "ğŸ“¥ Downloading dashboards from server..."
    @mkdir -p .storage
    @scp {{server}}:{{config_path}}/.storage/lovelace.dashboard_* .storage/ 2>/dev/null || echo "No dashboards found on server"
    @scp {{server}}:{{config_path}}/.storage/lovelace_dashboards .storage/ 2>/dev/null || echo "No dashboard registry found"
    @echo "âœ… Dashboards synced"
    @ls -la .storage/lovelace* 2>/dev/null || true

# Push a specific dashboard to server
# Usage: just config::push-dashboard bubbles
push-dashboard NAME:
    @echo "ğŸ“¤ Uploading dashboard '{{NAME}}'..."
    @python3 -m json.tool .storage/lovelace.dashboard_{{NAME}} > /dev/null || (echo "âŒ Invalid JSON in dashboard file" && exit 1)
    @scp .storage/lovelace.dashboard_{{NAME}} {{server}}:{{config_path}}/.storage/
    @echo "âœ… Dashboard '{{NAME}}' uploaded"
    @echo "âš ï¸  Restart HA for changes to take effect: just config::restart"

# Push all dashboards to server
push-dashboards:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ğŸ“¤ Uploading all dashboards..."
    for f in .storage/lovelace.dashboard_*; do
        python3 -m json.tool "$f" > /dev/null || { echo "âŒ Invalid JSON in $f"; exit 1; }
    done
    scp .storage/lovelace.dashboard_* {{server}}:{{config_path}}/.storage/
    scp .storage/lovelace_dashboards {{server}}:{{config_path}}/.storage/
    echo "âœ… All dashboards uploaded"
    echo "âš ï¸  Restart HA for changes to take effect: just config::restart"

# Deploy a dashboard (push + restart)
# Usage: just config::deploy-dashboard bubbles
deploy-dashboard NAME: (push-dashboard NAME) restart
    @echo "âœ… Dashboard '{{NAME}}' deployed and Home Assistant restarted"

# List dashboards on server
list-dashboards:
    @echo "ğŸ“‹ Dashboards on server:"
    @ssh {{server}} "ls -la {{config_path}}/.storage/lovelace.dashboard_* 2>/dev/null" || echo "No dashboards found"

# ============================================
# Voice Assistant / Exposed Entities
# ============================================
# 
# Exposure settings are stored in core.entity_registry (for entities with unique_id)
# Edit config/exposed_entities.yaml to define which entities to expose.
# Only entities listed with `true` will be exposed; all others in managed domains are hidden.
#
# CRITICAL: HA must be STOPPED before modifying core.entity_registry,
# otherwise HA overwrites changes on restart.

# Apply exposed_entities.yaml settings to entity registry (full workflow)
# Stops HA, applies changes, starts HA
deploy-exposed:
    @echo "ğŸ›‘ Stopping Home Assistant..."
    @ssh {{server}} "ha core stop"
    @echo "ğŸ“¤ Applying exposed entities config..."
    @uv run --directory .. update_exposed_entities.py
    @echo "ğŸš€ Starting Home Assistant..."
    @ssh {{server}} "ha core start" || true
    @echo "â³ Waiting 30s for startup..."
    @sleep 30
    @echo "âœ… Exposed entities deployed"

# Preview changes without applying (dry run)
check-exposed:
    @echo "ğŸ” Checking exposed entities (dry run)..."
    @uv run --directory .. update_exposed_entities.py --dry-run

# Show entities listed in exposed_entities.yaml
list-exposed:
    @echo "ğŸ“‹ Entities configured to expose (from exposed_entities.yaml):"
    @python3 -c "import yaml; d=yaml.safe_load(open('exposed_entities.yaml')); [print(f'  âœ… {k}') for k,v in d.items() if v]"

# Show what's actually exposed on the server (from entity registry)
list-exposed-server:
    @echo "ğŸ“‹ Entities currently exposed on server:"
    @ssh {{server}} "cat {{config_path}}/.storage/core.entity_registry" | python3 -c "import sys,json; d=json.load(sys.stdin); [print(f'  âœ… {e[\"entity_id\"]}') for e in d['data']['entities'] if e.get('options',{}).get('conversation',{}).get('should_expose')==True]"
