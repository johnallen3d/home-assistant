# Home Assistant Configuration Management

# Import server config from .env (loaded by root Justfile)
server := env_var('HA_SERVER')
config_path := env_var('HA_CONFIG_PATH')

# Default recipe - show help
default:
    @just --list

# Extract config files from HA server and split into individual files
extract:
    @echo "ðŸ“¥ Extracting configuration from Home Assistant..."
    @./extract.sh

# Alias for extract
pull: extract

# Upload configuration.yaml to HA server and re-sync
upload-config:
    @echo "ðŸ“¤ Uploading configuration.yaml..."
    @scp configuration.yaml {{server}}:{{config_path}}/configuration.yaml
    @echo "âœ… Configuration uploaded"
    @echo "ðŸ”„ Re-syncing local copy..."
    @./extract.sh

# Update a specific automation: pull from server, update from local file, push back, then re-sync
# Usage: just config::update-automation automations/bathroom_presence.yaml
update-automation FILE:
    @echo "ðŸ”§ Updating automation from {{FILE}}..."
    @uv run --directory .. update_automation.py {{FILE}}
    @echo "ðŸ”„ Re-syncing local copy..."
    @./extract.sh

# Update multiple automations at once
# Usage: just config::update-automations "automations/bathroom_presence.yaml automations/kitchen_button.yaml"
update-automations FILES:
    @echo "ðŸ”§ Updating automations..."
    @uv run --directory .. update_automation.py {{FILES}}
    @echo "ðŸ”„ Re-syncing local copy..."
    @./extract.sh

# Alias for update-automation
push-automation FILE: (update-automation FILE)

# Restart Home Assistant core (takes ~30s)
restart:
    @echo "ðŸ”„ Restarting Home Assistant core..."
    @ssh {{server}} "ha core restart" || true
    @echo "â³ Waiting 30s for restart..."
    @sleep 30
    @ssh {{server}} "ha info | head -3"
    @echo "âœ… Home Assistant restarted"

# Full workflow: upload config and restart
deploy: upload-config restart
    @echo "âœ… Configuration deployed and Home Assistant restarted"

# Check HA server status
status:
    @echo "ðŸ“Š Home Assistant status:"
    @ssh {{server}} "ha info"

# Show HA core logs
logs:
    @echo "ðŸ“‹ Streaming Home Assistant logs..."
    @ssh {{server}} "ha core logs -f"

# Backup current automations on server
backup:
    @echo "ðŸ’¾ Backing up automations..."
    @ssh {{server}} "cp {{config_path}}/automations.yaml {{config_path}}/automations.yaml.backup"
    @echo "âœ… Backup created: automations.yaml.backup"

# Show info about configuration
info:
    @echo "Server: {{server}}"
    @echo "Config path: {{config_path}}"
    @echo "Local automations: $(ls automations/*.yaml | wc -l | tr -d ' ') files"

# Create a new helper (input_number) in configuration.yaml
# Usage: just config::create-helper laundry_room_motion_delay "Laundry Room Motion Delay" 1 60 1 seconds 5
create-helper NAME DISPLAY_NAME MIN MAX STEP UNIT INITIAL:
    @echo "ðŸ”§ Creating helper '{{NAME}}'..."
    @echo "  {{NAME}}:" >> configuration.yaml
    @echo "    name: {{DISPLAY_NAME}}" >> configuration.yaml
    @echo "    min: {{MIN}}" >> configuration.yaml
    @echo "    max: {{MAX}}" >> configuration.yaml
    @echo "    step: {{STEP}}" >> configuration.yaml
    @echo "    unit_of_measurement: {{UNIT}}" >> configuration.yaml
    @echo "    icon: mdi:timer-outline" >> configuration.yaml
    @echo "    initial: {{INITIAL}}" >> configuration.yaml
    @echo "âœ… Helper '{{NAME}}' added to configuration.yaml"
    @echo "âš ï¸  Don't forget to run 'just config::upload-config' to deploy"

# Create local blueprints directory if it doesn't exist
init-blueprints:
    @mkdir -p blueprints/automation
    @echo "âœ… Blueprints directory created"

# Upload a blueprint to HA server
# Usage: just config::upload-blueprint blueprints/automation/my_blueprint.yaml
upload-blueprint FILE:
    @echo "ðŸ“¤ Uploading blueprint {{FILE}}..."
    @ssh {{server}} "mkdir -p {{config_path}}/blueprints/automation"
    @scp {{FILE}} {{server}}:{{config_path}}/{{FILE}}
    @echo "âœ… Blueprint uploaded"

# Pull all blueprints from server
pull-blueprints:
    @echo "ðŸ“¥ Downloading blueprints from server..."
    @mkdir -p blueprints/automation
    @scp -r {{server}}:{{config_path}}/blueprints/automation/*.yaml blueprints/automation/ 2>/dev/null || echo "No custom blueprints found on server"
    @echo "âœ… Blueprints synced"
