# Home Assistant Configuration Management

# Import server config from .env (loaded by root Justfile)
server := env_var('HA_SERVER')
config_path := env_var('HA_CONFIG_PATH')

# Default recipe - show help
default:
    @just --list

# Extract config files from HA server and split into individual files
extract:
    @echo "üì• Extracting configuration from Home Assistant..."
    @./extract.sh

# Alias for extract
pull: extract

# Upload configuration.yaml to HA server and re-sync
upload-config:
    @echo "üì§ Uploading configuration.yaml..."
    @scp configuration.yaml {{server}}:{{config_path}}/configuration.yaml
    @echo "‚úÖ Configuration uploaded"
    @echo "üîÑ Re-syncing local copy..."
    @./extract.sh

# Update a specific automation: pull from server, update from local file, push back, then re-sync
# Usage: just config::update-automation automations/bathroom_presence.yaml
update-automation FILE:
    @echo "üîß Updating automation from {{FILE}}..."
    @uv run --directory .. update_automation.py {{FILE}}
    @echo "üîÑ Re-syncing local copy..."
    @./extract.sh

# Update multiple automations at once
# Usage: just config::update-automations "automations/bathroom_presence.yaml automations/kitchen_button.yaml"
update-automations FILES:
    @echo "üîß Updating automations..."
    @uv run --directory .. update_automation.py {{FILES}}
    @echo "üîÑ Re-syncing local copy..."
    @./extract.sh

# Alias for update-automation
push-automation FILE: (update-automation FILE)

# Restart Home Assistant core (takes ~30s)
restart:
    @echo "üîÑ Restarting Home Assistant core..."
    @ssh {{server}} "ha core restart" || true
    @echo "‚è≥ Waiting 30s for restart..."
    @sleep 30
    @ssh {{server}} "ha info | head -3"
    @echo "‚úÖ Home Assistant restarted"

# Full workflow: upload config and restart
deploy: upload-config restart
    @echo "‚úÖ Configuration deployed and Home Assistant restarted"

# Check HA server status
status:
    @echo "üìä Home Assistant status:"
    @ssh {{server}} "ha info"

# Show HA core logs
logs:
    @echo "üìã Streaming Home Assistant logs..."
    @ssh {{server}} "ha core logs -f"

# Backup current automations on server
backup:
    @echo "üíæ Backing up automations..."
    @ssh {{server}} "cp {{config_path}}/automations.yaml {{config_path}}/automations.yaml.backup"
    @echo "‚úÖ Backup created: automations.yaml.backup"

# Show info about configuration
info:
    @echo "Server: {{server}}"
    @echo "Config path: {{config_path}}"
    @echo "Local automations: $(ls automations/*.yaml | wc -l | tr -d ' ') files"

# Create a new helper (input_number) in configuration.yaml
# Usage: just config::create-helper laundry_room_motion_delay "Laundry Room Motion Delay" 1 60 1 seconds 5
create-helper NAME DISPLAY_NAME MIN MAX STEP UNIT INITIAL:
    @echo "üîß Creating helper '{{NAME}}'..."
    @echo "  {{NAME}}:" >> configuration.yaml
    @echo "    name: {{DISPLAY_NAME}}" >> configuration.yaml
    @echo "    min: {{MIN}}" >> configuration.yaml
    @echo "    max: {{MAX}}" >> configuration.yaml
    @echo "    step: {{STEP}}" >> configuration.yaml
    @echo "    unit_of_measurement: {{UNIT}}" >> configuration.yaml
    @echo "    icon: mdi:timer-outline" >> configuration.yaml
    @echo "    initial: {{INITIAL}}" >> configuration.yaml
    @echo "‚úÖ Helper '{{NAME}}' added to configuration.yaml"
    @echo "‚ö†Ô∏è  Don't forget to run 'just config::upload-config' to deploy"
